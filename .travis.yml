sudo: required  
dist: trusty
language: node_js
node_js:
  - "6.9"
os:
  - linux
rvm:
  - 2.2.0
addons:
  chrome: stable
branches:
  only:
    - master
    - qa
cache:
  bundler: true
  directories:
    - ./node_modules/
stages:
  - cache
  # - name: tests-prod
  #   if: branch = master
  # - name: build-qa
  #   if: branch = qa
  - tests
  - name: deploy-prod
    if: branch = master AND type = push
  - name: deploy-qa
    if: branch = qa AND type = push 
  # - name: deploy-qa
  #   if: branch = qa
# before_install:
#   # start your web application and listen on `localhost`
#   - google-chrome-stable --headless --disable-gpu --remote-debugging-port=9222 http://localhost &
# install:
#   - npm i -g npm@5.7.1
#   - npm ci
jobs:
  include:
    - stage: cache
      script: echo "Cache node_modules ..."
    # - stage: build-prod
    #   script: 
    #     - npm run build:prod
    # - stage: build-qa
    #   script: 
    #     - npm run build:qa
    - stage: tests
      before_script:
        - rm -rf ./coverage
        # code climate
        - curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
        - chmod +x ./cc-test-reporter
        - ./cc-test-reporter before-build
      script: 
        - export CHROME_BIN=chromium-browser
        # test with coverage
        - xvfb-run -a npm run test:coverage -- --no-progress --single-run true --watch false --browsers ChromeHeadless
      after_script:
        # coveralls
        - cat ./coverage/lcov.info | ./node_modules/coveralls/bin/coveralls.js
        # code climate
        - ./cc-test-reporter after-build --exit-code $TRAVIS_TEST_RESULT
    - stage: tests
      script:
        # e2e tests
        - xvfb-run -a npm run e2e -- --no-progress --config=protractor-ci.conf.js
    - stage: deploy-prod
      script: 
        - echo "Deploying prod to azure ..."
        - npm run build:prod
      deploy:
        provider: azure_web_apps
        site: at-st-vsts
        on: master
    - stage: deploy-qa
      script: 
        - echo "Deploying qa to azure ..."
        - npm run build:prod
      deploy:
        provider: azure_web_apps
        site: at-st-vsts
        slot: qa
        on: qa









